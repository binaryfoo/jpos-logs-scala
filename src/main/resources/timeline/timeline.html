<!doctype html>
<html>
<head>
  <script src="jquery-latest.min.js"></script>
  <script src="d3.v3.min.js" charset="utf-8"></script>
  <script src="d3-timeline.js"></script>

  <style type="text/css">
    .axis path,
    .axis line {
      fill: none;
      stroke: black;
      shape-rendering: crispEdges;
    }

    .axis text {
      font-family: sans-serif;
      font-size: 10px;
    }

    .timeline-label {
      font-family: sans-serif;
      font-size: 12px;
    }

    #rightBox {
      position: fixed;
      top: 0;
      right: 0;
      width: 350px;
    }

    #eventListBox {
      height: 400px;
      overflow-y: scroll;
    }

    .coloredDiv {
      height:20px; width:20px; float:left;
    }

    #eventList {
      list-style-type: none;
      padding-left: 0;
    }

    rect.moused-over {
      fill: lightgrey !important;
    }
  </style>
  <script type="text/javascript">

    const timeFmt = d3.time.format("%H:%M:%S.%L");

    const msgTypeToColor = new Map();
    msgTypeToColor.set('receive', '#aec7e8');
    msgTypeToColor.set('send', '#1f77b4');
    msgTypeToColor.set('peer-disconnect', '#ff7f0e');
    msgTypeToColor.set('session-error', '#d62728');
    msgTypeToColor.set('session-start', '#2ca02c');
    msgTypeToColor.set('connect', '#98df8a');
    msgTypeToColor.set('session-end', '#8c564b');
    msgTypeToColor.set('tcp-overflow', '#e377c2');
    msgTypeToColor.set('io-timeout', '#9467bd');
    msgTypeToColor.set('warn', '#ffbb78');

    function colorForMsg(msgType) {
      let color = msgTypeToColor.get(msgType);
      return color ? color : '#bcbd22';
    }

    function prepare(data) {
      data.forEach((d) => {
        let dropTime = d.times.find((e) => e.msgType == "peer-disconnect");
        d.disconnect_time = dropTime == null ? 0 : dropTime.starting_time;
      });
      const byDisconnect = data.sort((a, b) => a.disconnect_time > b.disconnect_time);

      const slice = byDisconnect.slice(byDisconnect.length-2000, byDisconnect.length-1000);
      slice.forEach((series) => {
        series.times.forEach((event) => {
          event.color = colorForMsg(event.msgType);
          if (event.ending_time == event.starting_time) {
            event.ending_time += 1;
          }
        });
      });
      return slice;
    }

    function formatEvent(d) {
      const lifespan = d.ending_time - d.starting_time;
      return timeFmt(new Date(d.starting_time)) + " <span style=\"color: " + colorForMsg(d.msgType) + "\">" + d.msgType + "</span> (" + lifespan + "ms) " + d.summary
    }

    function reqListener() {
      const data = JSON.parse(this.responseText);
      const width = 1000;
      const chart = d3.timeline()
        .width(width * 4)
        .stack()
        .tickFormat({
          format: d3.time.format("%H:%M"),
          tickTime: d3.time.minutes,
          tickInterval: 1,
          tickSize: 6
        })
        .itemHeight(5)
        .itemMargin(2)
        .showAxisTop()
        .showTimeAxisTick()
        .margin({left: 70, right: 30, top: 0, bottom: 0})
        .hover(function (d, i, datum) {
          // d is the current rendering object
          // i is the index during d3 rendering
          // datum is the id object
          let hoverIndex = datum.times.indexOf(d);
          let firstIndex = Math.max(0, hoverIndex - 3);
          let lastIndex = Math.min(datum.times.length, hoverIndex + 3);
          let closeTimes = datum.times.slice(firstIndex, lastIndex);

          event.currentTarget.classList.add("moused-over");

          const div = $('#hoverRes');
          div.find('#socket').text(datum.socket);
          d3.selectAll("#eventList li").remove();
          d3.select("#eventList")
            .selectAll()
            .data(closeTimes)
            .enter()
            .append("li")
            .html(formatEvent)
            .style('font-weight', (dd) => dd == d ? 'bold' : 'normal');
        })
        .mouseout(function (d) {
          event.currentTarget.classList.remove("moused-over");
        })
        .click(function (d, i, datum) {
          console.log(arguments);
        });

      const svg = d3.select("#timeline3").append("svg").attr("width", width)
        .datum(prepare(data)).call(chart);
    }

    function reqError(err) {
      console.log('Fetch Error :-S', err);
    }

    const oReq = new XMLHttpRequest();
    oReq.onload = reqListener;
    oReq.onerror = reqError;
    oReq.open('get', '/timeline.json', true);
    oReq.send();

  </script>
</head>
<body>
  <div>
    <div id="timeline3"></div>
  </div>
  <div id="rightBox">
    <div id="hoverRes">
      <div class="coloredDiv"></div>
      <div id="socket"></div>
    </div>
    <div id="eventListBox">
      <ol id="eventList"></ol>
    </div>
  </div>
</body>
</html>
